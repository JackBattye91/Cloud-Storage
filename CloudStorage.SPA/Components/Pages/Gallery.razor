@page "/gallery"
@rendermode InteractiveServer
@inject IHttpClientFactory clientFactory;
@inject IConfiguration configuration;
@inject ISessionStorageService sessionStorage;
@inject ISnackbar snackbar;
@inject NavigationManager navManager;
<PageTitle>Gallery</PageTitle>

<MudContainer>
    <MudText Typo="Typo.h3">Gallery</MudText>
    
    @if (loadingBlobDetails)
    {
        <MudItem>
            <MudProgressCircular Indeterminate="true" />
        </MudItem>
    }
    else if (blobDetails?.Count > 0)
    {
        <MudBreadcrumbs Items="GetBreadcrumbs()" />
        <MudGrid>
            <!--
            <MudItem>
                <MudCheckBox @bind-Value="showPrivate" Label="Show Private" />
            </MudItem>
            -->
            <MudItem>
                <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label"
                                    Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    StartIcon="@Icons.Material.Filled.CloudUpload"
                                    for="@context.Id">
                            Upload Files
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudItem>
        </MudGrid>

        <MudGrid Justify="Justify.FlexStart">
            @if (folderPath.Count != 0)
            {
                <CloudStorage.SPA.Components.Views.FolderView FolderName=".." OnClick='() => { UpdateFolderPath(".."); }' />
            }
            else if (HasPrivateImages())
            {
                <CloudStorage.SPA.Components.Views.FolderView FolderName="Private" OnClick='() => { folderPath.Clear(); folderPath.Add("__private__");  }' />
            }

            @foreach (string folderName in GetFolders())
            {
                <CloudStorage.SPA.Components.Views.FolderView FolderName="@folderName" OnClick="() => { UpdateFolderPath(folderName); }" />
            }

            @foreach (BlobDetail blobDetail in GetBlobDetailsList())
            {
                <CloudStorage.SPA.Components.Views.BlobDetailView BlobDetail="blobDetail" OnClick="() => { ShowImage(blobDetail); }"/>
            }
        </MudGrid>
    }

</MudContainer>

<MudOverlay @bind-Visible="isOverlayVisible" DarkBackground="true" AutoClose="true" ZIndex="99999">
    @if (overlayImageLoading)
    {
        <MudProgressCircular Indeterminate="true"/>
    }
    else
    {
        <MudImage Src="@overlayImageSrc" Elevation="4" ObjectFit="ObjectFit.Contain" Style="max-height: 95vh; max-width: 100vw;" />
    }
    
</MudOverlay>

@code {
    string currentFolder = string.Empty;
    List<string> folderPath = new List<string>();
    User? user { get; set; } = null;
    List<BlobDetail>? blobDetails { get; set; }

    public bool showPrivate { get; set; } = false;
    bool loadingBlobDetails { get; set; } = true;
    bool isOverlayVisible { get; set; } = false;
    string overlayImageSrc { get; set; } = string.Empty;
    bool overlayImageLoading { get; set; } = false;

    protected override Task OnInitializedAsync()
    {
        string uri = navManager.ToBaseRelativePath(navManager.Uri);
        IDictionary<string, string> queryParamters = Worker.GetQueryParameters(uri);

        if(queryParamters.ContainsKey("route"))
        {
            currentFolder = queryParamters["route"];
            folderPath = currentFolder.Split('/').ToList();
        }

        return base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || user == null)
        {
            try
            {
                user = await sessionStorage.GetItemAsync<User>("user");

                if (user == null)
                {
                    navManager.NavigateTo("/");
                }

                if (blobDetails == null)
                {
                    await GetBlobDetails();
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                snackbar.Add(ex.Message, Severity.Error);
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    protected async Task GetBlobDetails()
    {
        loadingBlobDetails = true;
        try
        {
            HttpClient client = clientFactory.CreateClient("api");

            HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Get, "/Blob");
            HttpResponseMessage responseMessage = await client.SendAsync(requestMessage);

            if (responseMessage.IsSuccessStatusCode)
            {
                string content = await responseMessage.Content.ReadAsStringAsync();
                blobDetails = JsonConvert.DeserializeObject<List<BlobDetail>>(content);

                if (blobDetails != null)
                {
                    //await sessionStorage.SetItemAsync<string>("blobDetailsList", content);
                }
            }
        }
        catch (Exception ex)
        {
            snackbar.Add(ex.Message, Severity.Error);
        }

        loadingBlobDetails = false;
    }

    private async void UploadFiles(IBrowserFile file)
    {
        try
        {
            byte[] data = new byte[(int)file.Size];
            Stream stream = file.OpenReadStream(long.MaxValue);
            await stream.ReadAsync(data);
            string imageB64 = Convert.ToBase64String(data);

            FileUpload fileUpload = new FileUpload()
            {
                ContainerName = "pictures",
                FileExtension = file.Name.Remove(0, file.Name.LastIndexOf('.')),
                FileName = Guid.NewGuid().ToString(),
                DataBase64 = imageB64
            };

            string fileUploadContent = JsonConvert.SerializeObject(fileUpload);

            HttpClient client = clientFactory.CreateClient("api");
            HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Post, "/Blob");
            requestMessage.Content = new StringContent(fileUploadContent, System.Text.Encoding.UTF8, "application/json");

            HttpResponseMessage responseMessage = await client.SendAsync(requestMessage);

            if (responseMessage.IsSuccessStatusCode)
            {
                await GetBlobDetails();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private List<string> GetFolders()
    {
        List<string> folderList = new List<string>();
        string route = GetRoute().Trim('/');

        foreach(BlobDetail detail in blobDetails?.Where(x => x.FileName.StartsWith(route)).ToList() ?? [])
        {
            string relativeFileName =  string.IsNullOrEmpty(route) ? detail.FileName : detail.FileName.Replace(route, "").Trim('/');

            int fileNameStart = relativeFileName.LastIndexOf('/');
            string fileName = fileNameStart != -1 ? relativeFileName.Substring(fileNameStart + 1) : relativeFileName;
            string folderPath = fileNameStart != -1 ? relativeFileName.Substring(0, fileNameStart) : "";
            string[] folders = folderPath.Length > 0 ? folderPath.Split('/') : [];

            if (folders.Length >= 1)
            {
                if (!folderList.Contains(folders[0]))
                {
                    folderList.Add(folders[0]);
                }
            }
        }

        return folderList;
    }

    private List<BlobDetail> GetBlobDetailsList() {
        List<BlobDetail> detailsList = new List<BlobDetail>();
        string route = GetRoute().Trim('/');
        if (string.Equals(route, "__private__"))
        {
            return blobDetails?.Where(x => x.Private == true).ToList() ?? [];
        }

        foreach(BlobDetail detail in blobDetails ?? [])
        {
            if (detail.FileName.StartsWith(route) && detail.Private == false)
            {
                string remainingFileName = detail.FileName.Remove(0, route.Length).Trim('/');

                if (!remainingFileName.Contains("/"))
                {
                    detailsList.Add(detail);
                }
            }
        }

        return detailsList;
    }

    private bool HasPrivateImages()
    {
        return false;
        return blobDetails?.Any(x => x.Private == true) ?? false;
    }

    private async void ShowImage(IBlobDetail pBlobDetail)
    {
        try
        {
            isOverlayVisible = true;
            overlayImageLoading = true;

            HttpClient client = clientFactory.CreateClient("api");
            HttpRequestMessage imageRequest = new HttpRequestMessage(HttpMethod.Get, $"Blob/{pBlobDetail.FileName}");
            HttpResponseMessage imageResponse = await client.SendAsync(imageRequest);

            if (imageResponse.IsSuccessStatusCode)
            {
                byte[] imageData = await imageResponse.Content.ReadAsByteArrayAsync();
                string base64Image = Convert.ToBase64String(imageData);

                overlayImageSrc = $"data:image/jpg;base64, {base64Image}";
                overlayImageLoading = false;
                StateHasChanged();
            }

        }
        catch (Exception ex)
        {
            isOverlayVisible = false;
        }
    }

    private List<BreadcrumbItem> GetBreadcrumbs()
    {
        List<BreadcrumbItem> breadcrumbs = new List<BreadcrumbItem>();

        if (folderPath?.Count() == 0)
        {
            breadcrumbs.Add(new BreadcrumbItem("", "/Gallery", false, Icons.Material.Outlined.Folder));
        }

        StringBuilder fullPath = new StringBuilder(currentFolder);
        foreach(string path in folderPath ?? [])
        {
            if (string.Equals(path, "__private__"))
            {
                breadcrumbs.Add(new BreadcrumbItem("Private", "/Gallery?route=__private__", false, Icons.Material.Outlined.Folder));
            }
            else {
                fullPath.Append($"/{path.Trim('/')}");
                breadcrumbs.Add(new BreadcrumbItem(path, $"/Gallery?route={fullPath}", false, Icons.Material.Outlined.Folder));
            }
        }

        return breadcrumbs;
    }

    private void UpdateFolderPath(string pPath)
    {
        if (string.Equals(pPath.Trim(), "..") && folderPath.Count() > 0)
        {
            folderPath.RemoveAt(folderPath.Count() - 1);
        }
        else
        {
            folderPath.Add(pPath);
        }
        StateHasChanged();
    }

    private string GetRoute()
    {
        StringBuilder route = new StringBuilder();
        foreach (string path in folderPath)
        {
            route.Append($"/{path}");
        }

        return route.ToString();
    }
}
