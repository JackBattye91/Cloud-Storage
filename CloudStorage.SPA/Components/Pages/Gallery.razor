@page "/gallery"
@rendermode InteractiveServer
@inject IHttpClientFactory clientFactory;
@inject IConfiguration configuration;
@inject ISessionStorageService sessionStorage;
@inject ISnackbar snackbar;
@inject NavigationManager navManager;
<PageTitle>Gallery</PageTitle>


<MudContainer>
    <MudText Typo="Typo.h3">Gallery</MudText>
    
    @if (loadingBlobDetails)
    {
        <MudItem>
            <MudProgressCircular Indeterminate="true" />
        </MudItem>
    }
    else if (blobDetails?.Count > 0)
    {
        <MudBreadcrumbs Items="breadcrumbItems" />
        <MudGrid>
            <MudItem>
                <MudCheckBox @bind-Value="showPrivate" Label="Show Private" />
            </MudItem>
            <MudItem>
                <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label"
                                    Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    StartIcon="@Icons.Material.Filled.CloudUpload"
                                    for="@context.Id">
                            Upload Files
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudItem>
        </MudGrid>
        <MudGrid Justify="Justify.FlexStart">
            @if (HasPrivateImages())
            {
                
            }

            @foreach (BlobDetail blobDetail in GetBlobDetailsList())
            {
                <CloudStorage.SPA.Components.Views.BlobDetailView BlobDetail="blobDetail" OnClick="() => { ShowImage(blobDetail); }"/>
            }
        </MudGrid>
    }

</MudContainer>

<MudOverlay @bind-Visible="isOverlayVisible" DarkBackground="true" AutoClose="true" ZIndex="99999">
    @if (overlayImageLoading)
    {
        <MudProgressCircular Indeterminate="true"/>
    }
    else
    {
        <MudImage Src="@overlayImageSrc" Elevation="4" ObjectFit="ObjectFit.Contain" Style="max-height: 95vh; max-width: 100vw;" />
    }
    
</MudOverlay>

@code {
    List<BreadcrumbItem> breadcrumbItems = new List<BreadcrumbItem>() { new BreadcrumbItem("/", "/Gallery") };
    User? user { get; set; } = null;
    List<BlobDetail>? blobDetails { get; set; }

    public bool showPrivate { get; set; } = false;
    bool loadingBlobDetails { get; set; } = true;
    bool isOverlayVisible { get; set; } = false;
    string overlayImageSrc { get; set; } = string.Empty;
    bool overlayImageLoading { get; set; } = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || user == null)
        {
            try
            {
                user = await sessionStorage.GetItemAsync<User>("user");

                if (user == null)
                {
                    navManager.NavigateTo("/");
                }

                if (blobDetails == null)
                {
                    await GetBlobDetails();
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                snackbar.Add(ex.Message, Severity.Error);
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    protected async Task GetBlobDetails()
    {
        loadingBlobDetails = true;
        try
        {
            HttpClient client = clientFactory.CreateClient("api");

            HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Get, "/Blob");
            HttpResponseMessage responseMessage = await client.SendAsync(requestMessage);

            if (responseMessage.IsSuccessStatusCode)
            {
                string content = await responseMessage.Content.ReadAsStringAsync();
                blobDetails = JsonConvert.DeserializeObject<List<BlobDetail>>(content);

                if (blobDetails != null)
                {
                    //await sessionStorage.SetItemAsync<string>("blobDetailsList", content);
                }
            }
        }
        catch (Exception ex)
        {
            snackbar.Add(ex.Message, Severity.Error);
        }

        loadingBlobDetails = false;
    }

    private async void UploadFiles(IBrowserFile file)
    {
        try
        {
            byte[] data = new byte[(int)file.Size];
            Stream stream = file.OpenReadStream(long.MaxValue);
            await stream.ReadAsync(data);
            string imageB64 = Convert.ToBase64String(data);

            FileUpload fileUpload = new FileUpload()
            {
                ContainerName = "pictures",
                FileExtension = file.Name.Remove(0, file.Name.LastIndexOf('.')),
                FileName = Guid.NewGuid().ToString(),
                DataBase64 = imageB64
            };

            string fileUploadContent = JsonConvert.SerializeObject(fileUpload);

            HttpClient client = clientFactory.CreateClient("api");
            HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Post, "/Blob");
            requestMessage.Content = new StringContent(fileUploadContent, System.Text.Encoding.UTF8, "application/json");

            HttpResponseMessage responseMessage = await client.SendAsync(requestMessage);

            if (responseMessage.IsSuccessStatusCode)
            {
                await GetBlobDetails();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private List<BlobDetail> GetBlobDetailsList() {
        if (blobDetails == null)
        {
            return new List<BlobDetail>();
        }

        if (showPrivate == true)
        {
            return blobDetails;
        }

        return blobDetails!.Where(x => x.Private == false).ToList();
    }

    private bool HasPrivateImages()
    {
        return blobDetails?.Any(x => x.Private == true) ?? false;
    }


    private async void ShowImage(IBlobDetail pBlobDetail)
    {
        try
        {
            isOverlayVisible = true;
            overlayImageLoading = true;

            HttpClient client = clientFactory.CreateClient("api");
            HttpRequestMessage imageRequest = new HttpRequestMessage(HttpMethod.Get, $"Blob/{pBlobDetail.FileName}");
            HttpResponseMessage imageResponse = await client.SendAsync(imageRequest);

            if (imageResponse.IsSuccessStatusCode)
            {
                byte[] imageData = await imageResponse.Content.ReadAsByteArrayAsync();
                string base64Image = Convert.ToBase64String(imageData);

                overlayImageSrc = $"data:image/png;base64, {base64Image}";
                overlayImageLoading = false;
                StateHasChanged();
            }
            
        }
        catch (Exception ex)
        {
            isOverlayVisible = false;
        }
    }
}
